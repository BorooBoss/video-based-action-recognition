<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Recognizer</title>
</head>
<body>
  <h1>Image Recognizer</h1>

  <form id="recognize-form" enctype="multipart/form-data">
    <label>Choose model:</label>
    <select name="model">
      <option value="google/paligemma2-3b-pt-224">paligemma2-3b-pt-224</option>
      <option value="google/paligemma2-3b-mix-224">paligemma2-3b-mix-224</option>
      <option value="microsoft/Florence-2-base">florence-2-base</option>
      <option value="florence-2vqa-tresting">florence-2vqa-tresting</option>
      <option value="qwen-testing">qwen-testing</option>
    </select>

    <br><br>

    <!-- Prompt type dropdown (user-friendly) -->
    <label>Prompt Type:</label>
    <select name="prompt_type" id="prompt-type-select" style="text-transform: uppercase;">
      <option value="DETECT">DETECT</option>
      <option value="CAPTION">CAPTION</option>
      <option value="DESCRIBE">DESCRIBE</option>
      <option value="ANSWER">ANSWER</option>
    </select>

    <br><br>

    <label>Addition:</label>
    <input type="text" name="addition" placeholder="some extra input">

    <br><br>

    <label>Image:</label>
    <input type="file" name="image" id="image-input" required>

    <br><br>
    <img id="preview" width="500" height="300">

    <br><br>

    <button type="submit">Recognize</button>
  </form>

  <hr>

  <h3>Result:</h3>
  <pre id="result-box">No result yet.</pre>

  <script>
    const form = document.getElementById('recognize-form');
    const resultBox = document.getElementById('result-box');
    const imageInput = document.getElementById('image-input');
    const preview = document.getElementById('preview');

    imageInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
          preview.src = event.target.result;
        };
        reader.readAsDataURL(file);
      }
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(form);
      resultBox.textContent = "Processing...";

      try {
        const response = await fetch('/recognizer/recognize/', {
          method: 'POST',
          body: formData
        });

        const data = await response.json();
        console.log("Full response:", data);
        console.log("Annotated image:", data.annotated_image);

        if (data.result) {
          resultBox.textContent = `Model: ${data.model}\nPrompt: ${data.prompt}\nResult: ${JSON.stringify(data.result)}`;

          if (data.annotated_image) {
            console.log("Setting preview to annotated image");
            preview.src = data.annotated_image;
          }
        } else {
          resultBox.textContent = `Error: ${data.error}`;
        }
      } catch (err) {
        resultBox.textContent = `Request failed: ${err}`;
      }
    });
  </script>
</body>
</html>